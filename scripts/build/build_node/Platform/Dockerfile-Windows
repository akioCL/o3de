
FROM mcr.microsoft.com/dotnet/framework/sdk:4.8-windowsservercore-ltsc2019

# Install Chocolatey package manager
ENV ChocolateyUseWindowsCompression false
RUN Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iwr https://chocolatey.org/install.ps1 -UseBasicParsing | iex
RUN choco feature enable -n=allowGlobalConfirmation

# Install latest powershell (7.0.2)
RUN choco install -f powershell-core

# Set powershell 7 as default for every subsequent command
SHELL ["pwsh", "-command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

# Install dependancies
RUN choco install -f 7zip
RUN choco install -f windirstat
RUN choco install -f --ignore-checksums sysinternals

# Install source control apps 
RUN choco install -f git
RUN choco install -f git-lfs

# Install Java (for Jenkins)
# Custom directory to handle cases where whitespace in the path is not quote wrapped
RUN choco install -f corretto8jdk --ia INSTALLDIR="c:\jdk8"

# Install CMake
RUN choco install -f cmake --installargs 'ADD_CMAKE_TO_PATH=System'

# NuGet
RUN choco install -fy nuget.commandline

# Copy all script files
COPY Windows /
COPY Common /

# Download the Build Tools bootstrapper.
RUN curl -SL --output vs_buildtools.exe https://aka.ms/vs/16/release/vs_buildtools.exe

# Restore the default Windows shell for correct batch processing.
# SHELL ["cmd", "/S", "/C"]

# Modify existing Visual Studio Build Tools with MSVC workload
#RUN cmd /c "vs_buildtools.exe --quiet --wait --norestart --nocache modify --installPath `"%ProgramFiles%\Microsoft Visual Studio\2019\BuildTools`" --config vs2019bt.vsconfig || if `"%ERRORLEVEL%`"==`"3010`" EXIT 0 && del /q vs_buildtools.exe"
RUN cmd /c "vs_buildtools.exe modify --quiet --wait --norestart --nocache modify --installPath 'C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools' \
    --add Microsoft.Component.MSBuild \
    --add Microsoft.VisualStudio.Component.CoreBuildTools \
    --add Microsoft.VisualStudio.Component.VC.CoreBuildTools \
    --add Microsoft.VisualStudio.Component.VC.Tools.x86.x64 \
    --add Microsoft.VisualStudio.Component.Windows10SDK \
    --add Microsoft.VisualStudio.Component.Windows10SDK.18362 \
    --add Microsoft.VisualStudio.ComponentGroup.NativeDesktop.Core \
    --add Microsoft.VisualStudio.ComponentGroup.UWP.BuildTools \
    --add Microsoft.VisualStudio.Workload.MSBuildTools \
    --add Microsoft.VisualStudio.Workload.UniversalBuildTools \
    --add Microsoft.VisualStudio.Workload.VCTools"

# Install Windows 10 SDK (Not part of the VS tools)
RUN choco install windows-sdk-10.1

# Install Windows Installer XML toolkit (WiX)
#RUN choco install -f wixtoolset

# Install Python and associated dependancies
RUN choco install -f python3 --version=3.7.9
RUN pip3 install -r requirements.txt

RUN mkdir -p C:\ProgramData\AWSCodeBuild\bin ; mkdir -p C:\ProgramData\AWSCodeBuild\features

# Configure SSH
#COPY ssh_config /Users/ContainerAdministrator/.ssh/config

# Set longpath in registry
RUN Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\FileSystem' -Name 'LongPathsEnabled' -value 1

# Disable Admin prompts
RUN New-ItemProperty -Path HKLM:Software\Microsoft\Windows\CurrentVersion\policies\system -Name EnableLUA -PropertyType DWord -Value 0 -Force
RUN New-ItemProperty -Path HKLM:Software\Microsoft\Windows\CurrentVersion\policies\system -Name ConsentPromptBehaviorAdmin -PropertyType DWord -Value 0 -Force

# Reload environment variables system file
RUN refreshenv

# Define the entry point for the docker container.
# This entry point starts the developer command prompt and launches the PowerShell shell.
ENTRYPOINT ["C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\BuildTools\\Common7\\Tools\\VsDevCmd.bat", "&&", "powershell.exe", "-NoLogo", "-ExecutionPolicy", "Bypass"]